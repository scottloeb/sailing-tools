<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataTrellis</title>
    <style>
        /* Base styles and variables */
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #93c5fd;
            --secondary: #6366f1;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --radius: 6px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.2s ease;
            
            /* Trellis-specific design elements */
            --trellis-color: rgba(59, 130, 246, 0.07);
            --trellis-accent: rgba(59, 130, 246, 0.12);
        }
        
        /* Dark theme support */
        :root.dark-theme {
            --primary: #e6a64c;          /* Warm amber instead of blue */
            --primary-dark: #d18f30;     /* Darker amber for contrast */
            --primary-light: #f7c989;    /* Light amber for subtle highlights */
            --secondary: #d18fb0;        /* Soft mauve as secondary color */
            
            /* Background colors - warmer and softer than current dark blues */
            --gray-50: #232220;          /* Slightly warm very dark background */
            --gray-100: #2d2b29;         /* Slightly warmer card backgrounds */
            --gray-200: #3d3a38;         /* Soft dark for borders and separators */
            --gray-300: #504d4a;         /* Medium elements */
            --gray-400: #6e6b68;         /* Subtle UI elements */
            
            /* Text colors - reduced brightness and warmer tones */
            --gray-500: #9c9996;         /* Secondary text */
            --gray-600: #b8b5b2;         /* Primary text */
            --gray-700: #d4d1ce;         /* Emphasized text */
            --gray-800: #e6e3e0;         /* Strong text (not pure white) */
            --gray-900: #f2efe8;         /* Headings (slightly off-white) */
            
            /* Trellis patterns - using the amber primary color */
            --trellis-color: rgba(230, 166, 76, 0.08);
            --trellis-accent: rgba(230, 166, 76, 0.15);
            
            /* Additional variables for better readability */
            --success: #7cb36a;          /* Muted green instead of bright */
            --error: #d97862;            /* Softer red */
            --warning: #e6a64c;          /* Same as primary for consistency */
            --info: #6ba5b8;             /* Muted teal instead of bright blue */
}
        
        /* Base elements */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--gray-50);
            color: var(--gray-800);
            line-height: 1.5;
        }
        
        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            margin-top: 0;
            color: var(--gray-900);
            font-weight: 600;
        }
        
        p {
            margin-top: 0;
            margin-bottom: 1rem;
        }
        
        /* App Layout */
        .app-layout {
            display: flex;
            min-height: 100vh;
            position: relative;
        }
        
        /* Layout components */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            width: 100%;
            transition: margin-left 0.3s ease;
        }
        
        .container.drawer-open {
            margin-left: 240px;
        }
        
        .header {
            padding: 1rem 0;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .header h1 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            margin: 0;
        }
        
        .header-icon {
            color: var(--primary);
            margin-right: 0.5rem;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .main-content {
            min-height: calc(100vh - 200px);
        }
        
        /* Plugin Drawer */
        .plugin-drawer {
            width: 240px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background-color: white;
            border-right: 1px solid var(--gray-200);
            transform: translateX(-240px);
            transition: transform 0.3s ease;
            z-index: 100;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
            padding-top: 70px;
        }
        
        .plugin-drawer.open {
            transform: translateX(0);
        }
        
        .drawer-toggle {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 48px;
            background-color: white;
            border: 1px solid var(--gray-200);
            border-left: none;
            border-radius: 0 4px 4px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 101;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        .drawer-toggle-icon {
            width: 16px;
            height: 16px;
            color: var(--gray-600);
        }
        
        .plugin-section {
            margin-bottom: 15px;
        }
        
        .plugin-section-title {
            padding: 8px 15px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-600);
            background-color: var(--gray-100);
            position: relative;
            overflow: hidden;
        }
        
        .plugin-section-title::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 100%;
            background-image: linear-gradient(to right, transparent, var(--gray-100)),
                              repeating-linear-gradient(45deg, transparent, transparent 4px, var(--trellis-accent) 4px, var(--trellis-accent) 5px);
            opacity: 0.3;
        }
        
        .plugin-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .plugin-item:hover {
            background-color: var(--gray-100);
        }
        
        .plugin-item.active {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }
        
        .plugin-icon {
            margin-right: 10px;
            color: var(--primary);
            flex-shrink: 0;
            width: 18px;
            height: 18px;
        }
        
        /* Theme toggle */
        .theme-toggle {
            position: relative;
            width: 44px;
            height: 22px;
            border-radius: 11px;
            background-color: var(--gray-300);
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            padding: 0 4px;
        }
        
        .theme-toggle::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: white;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }
        
        .theme-toggle.dark::after {
            transform: translateX(22px);
        }
        
        .theme-toggle.dark {
            background-color: var(--primary);
        }
        
        .theme-toggle-icon {
            width: 12px;
            height: 12px;
            color: var(--gray-500);
            z-index: 1;
        }
        
        .theme-toggle-icon.sun {
            margin-left: auto;
        }
        
        /* Components */
        .card {
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .card-footer {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Form elements and buttons */
        button, .button, select, input {
            font-family: inherit;
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            transition: var(--transition);
        }
        
        button, .button {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        
        button:hover, .button:hover {
            background-color: var(--primary-dark);
        }
        
        button:disabled, .button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        button.secondary, .button.secondary {
            background-color: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }
        
        button.secondary:hover, .button.secondary:hover {
            background-color: var(--gray-100);
        }
        
        select, input[type="text"] {
            border: 1px solid var(--gray-300);
            background-color: white;
        }
        
        select:focus, input:focus {
            outline: 2px solid var(--primary-light);
            outline-offset: 1px;
        }
        
        .search-container {
            position: relative;
            display: inline-block;
        }
        
        .search-container input {
            padding-right: 2.5rem;
        }
        
        .clear-button {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            background: none;
            border: none;
            color: var(--gray-500);
            font-size: 1rem;
            cursor: pointer;
            padding: 0 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .clear-button:hover {
            color: var(--gray-800);
            background: none;
        }
        
        /* Navbar and controls */
        .navbar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 1rem;
            align-items: flex-end;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            flex: 1;
            min-width: 180px;
        }
        
        .control-group label {
            font-weight: 500;
            color: var(--gray-700);
            font-size: 0.875rem;
        }
        
        .control-actions {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        
        /* Table styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        
        th, td {
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--gray-200);
        }
        
        th {
            font-weight: 600;
            color: var(--gray-700);
            background-color: var(--gray-100);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tbody tr:hover td {
            background-color: var(--gray-100);
        }
        
        .table-container {
            overflow-x: auto;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            background-color: white;
        }
        
        /* Stats summary bar - subtle version */
        .stats-summary {
            display: flex;
            gap: 2rem;
            font-size: 0.875rem;
            color: var(--gray-600);
            padding: 0.75rem 1rem;
            background-color: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-bottom: none;
            border-radius: var(--radius) var(--radius) 0 0;
            justify-content: flex-start;
        }
        
        .stats-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .stats-value {
            font-weight: 600;
            color: var(--gray-900);
        }
        
        /* File tabs for multiple CSVs */
        .file-tabs {
            display: flex;
            gap: 0.25rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .file-tab {
            background-color: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius) var(--radius) 0 0;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
            color: var(--gray-700);
            transition: var(--transition);
        }
        
        .file-tab:hover {
            background-color: white;
        }
        
        .file-tab.active {
            background-color: white;
            border-bottom-color: white;
            color: var(--primary);
            font-weight: 500;
        }
        
        .file-tab-close {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--gray-500);
            transition: var(--transition);
        }
        
        .file-tab-close:hover {
            background-color: var(--gray-200);
            color: var(--gray-800);
        }
        
        .add-file-tab {
            border: 1px dashed var(--gray-300);
            background-color: transparent;
            color: var(--gray-600);
            border-radius: var(--radius);
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .add-file-tab:hover {
            background-color: var(--gray-100);
            color: var(--gray-800);
        }
        
        /* Drop zone for CSV upload */
        .drop-zone {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius);
            background-color: var(--gray-50);
            margin-bottom: 1.5rem;
            transition: var(--transition);
            cursor: pointer;
            text-align: center;
            position: relative;
        }
        
        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--primary);
            background-color: var(--gray-100);
        }
        
        .drop-zone-icon {
            font-size: 2.5rem;
            color: var(--gray-400);
            margin-bottom: 1rem;
        }
        
        .drop-zone-text {
            color: var(--gray-600);
            margin-bottom: 1rem;
        }
        
        .drop-zone-button {
            background-color: white;
            color: var(--primary);
            border: 1px solid var(--primary);
            margin-top: 1rem;
        }
        
        .drop-zone-button:hover {
            background-color: var(--primary);
            color: white;
        }
        
        .drop-zone input[type="file"] {
            display: none;
        }
        
        /* Trellis patterns */
        .header::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 120px;
            height: 100%;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 7px, var(--trellis-color) 7px, var(--trellis-color) 8px),
                repeating-linear-gradient(90deg, transparent, transparent 7px, var(--trellis-color) 7px, var(--trellis-color) 8px);
            opacity: 0.15;
            pointer-events: none;
        }
        
        .drop-zone::after {
            content: "";
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 100px;
            height: 100px;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 10px, var(--trellis-color) 10px, var(--trellis-color) 11px),
                repeating-linear-gradient(135deg, transparent, transparent 10px, var(--trellis-color) 10px, var(--trellis-color) 11px);
            opacity: 0.2;
            pointer-events: none;
            border-radius: var(--radius);
        }
        
        /* Welcome screen */
        .welcome-container {
            text-align: center;
            padding: 3rem 1rem;
            position: relative;
        }
        
        .welcome-container::after {
            content: "";
            position: absolute;
            bottom: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 15px, var(--trellis-color) 15px, var(--trellis-color) 16px),
                repeating-linear-gradient(90deg, transparent, transparent 15px, var(--trellis-color) 15px, var(--trellis-color) 16px);
            opacity: 0.1;
            pointer-events: none;
            z-index: -1;
        }
        
        .welcome-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
        }
        
        .welcome-title {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        
        .welcome-subtitle {
            font-size: 1.25rem;
            color: var(--gray-600);
            margin-bottom: 2rem;
        }
        
        .features-list {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .feature-item {
            flex: 1;
            min-width: 250px;
            max-width: 300px;
            background-color: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: left;
        }
        
        .feature-icon {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .feature-title {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }
        
        /* Results section */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .results-summary {
            color: var(--gray-600);
        }
        
        .results-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .no-results {
            padding: 3rem 1rem;
            text-align: center;
            color: var(--gray-600);
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--gray-200);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* View selector */
        .view-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .view-selector-option {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--gray-300);
            background-color: white;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .view-selector-option:hover {
            background-color: var(--gray-100);
        }
        
        .view-selector-option.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Visualization container */
        .visualization-container {
            width: 100%;
            min-height: 300px;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .visualization-placeholder {
            color: var(--gray-500);
            text-align: center;
            padding: 2rem;
        }
        
        /* Template modal */
        .template-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }
        
        .template-modal-backdrop.active {
            opacity: 1;
            visibility: visible;
        }
        
        .template-modal {
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        
        .template-modal-backdrop.active .template-modal {
            transform: translateY(0);
        }
        
        .template-modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .template-modal-title {
            margin: 0;
            font-size: 1.25rem;
        }
        
        .template-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        
        .template-modal-close:hover {
            background-color: var(--gray-100);
            color: var(--gray-800);
        }
        
        .template-modal-body {
            padding: 1.5rem;
        }
        
        .template-modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .template-code {
            background-color: var(--gray-100);
            border-radius: var(--radius);
            padding: 1rem;
            overflow-x: auto;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            white-space: pre;
        }
        
        /* Plugin management modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }
        
        .modal-backdrop.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        
        .modal-backdrop.active .modal {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.25rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        
        .modal-close:hover {
            background-color: var(--gray-100);
            color: var(--gray-800);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                width: 100%;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .stats-summary {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .plugin-drawer {
                width: 100%;
                transform: translateX(-100%);
            }
            
            .container.drawer-open {
                margin-left: 0;
            }
            
            .plugin-drawer.open {
                transform: translateX(0);
            }
        }
        
        /* Utility classes */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mb-1 {
            margin-bottom: 0.25rem;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        
        .mb-4 {
            margin-bottom: 1rem;
        }
        
        .mb-8 {
            margin-bottom: 2rem;
        }
        
        .flex {
            display: flex;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-2 {
            gap: 0.5rem;
        }

        /* Dark mode overrides for hardcoded background colors */
        :root.dark-theme .card,
        :root.dark-theme .navbar,
        :root.dark-theme .table-container,
        :root.dark-theme .modal,
        :root.dark-theme .modal-header,
        :root.dark-theme .modal-body,
        :root.dark-theme .modal-footer,
        :root.dark-theme .feature-item,
        :root.dark-theme .plugin-drawer,
        :root.dark-theme .visualization-container,
        :root.dark-theme .drawer-toggle,
        :root.dark-theme .theme-toggle::after,
        :root.dark-theme .file-tab.active,
        :root.dark-theme .view-selector-option:not(.active) {
            background-color: var(--gray-100);
        }

        /* Ensure buttons with white backgrounds also change */
        :root.dark-theme button.secondary,
        :root.dark-theme .button.secondary,
        :root.dark-theme .file-tab {
            background-color: var(--gray-200);
            color: var(--gray-700);
            border-color: var(--gray-300);
        }

        /* Improve text readability on dark backgrounds */
        :root.dark-theme .feature-item,
        :root.dark-theme .card,
        :root.dark-theme .modal-body {
            color: var(--gray-600);
        }

        /* Ensure headings remain visible in dark mode */
        :root.dark-theme .feature-title,
        :root.dark-theme .card-title,
        :root.dark-theme .modal-title,
        :root.dark-theme h1, 
        :root.dark-theme h2, 
        :root.dark-theme h3, 
        :root.dark-theme h4 {
            color: var(--gray-800);
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Plugin Drawer -->
        <div class="plugin-drawer" id="plugin-drawer">
            <div class="plugin-section">
                <div class="plugin-section-title">Visualizations</div>
                <div class="plugin-item active" data-view="table">
                    <svg class="plugin-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="3" y1="9" x2="21" y2="9"></line>
                        <line x1="3" y1="15" x2="21" y2="15"></line>
                        <line x1="9" y1="3" x2="9" y2="21"></line>
                        <line x1="15" y1="3" x2="15" y2="21"></line>
                    </svg>
                    Table View
                </div>
                <!-- Additional view plugins will be added here dynamically -->
            </div>
            
            <div class="plugin-section">
                <div class="plugin-section-title">Tools</div>
                <div class="plugin-item" id="add-plugin-btn">
                    <svg class="plugin-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="12" y1="8" x2="12" y2="16"></line>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                    </svg>
                    Add New Tool
                </div>
            </div>
            
            <div class="plugin-section">
                <div class="plugin-section-title">Developer</div>
                <div class="plugin-item" id="view-template-btn">
                    <svg class="plugin-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <line x1="10" y1="9" x2="8" y2="9"></line>
                    </svg>
                    Plugin Template
                </div>
            </div>
        </div>

        <!-- Drawer Toggle Button -->
        <div class="drawer-toggle" id="drawer-toggle">
            <svg class="drawer-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </div>

        <!-- Main Container -->
        <div class="container" id="main-container">
            <header class="header">
                <h1>
                    <svg class="header-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 3h18v18H3z"></path>
                        <path d="M9 14v1M9 19v-2M15 14v1M15 19v-2M9 8.5v-1M15 8.5v-1"></path>
                        <path d="M12 12a3 3 0 100-6 3 3 0 000 6z"></path>
                    </svg>
                    DataTrellis
                </h1>
                <div class="header-actions">
                    <div class="theme-toggle" id="theme-toggle" title="Toggle light/dark theme">
                        <svg class="theme-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <svg class="theme-toggle-icon sun" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </div>
                </div>
            </header>

            <main class="main-content">
                <!-- File upload section (initially visible) -->
                <div id="upload-section">
                    <div class="welcome-container">
                        <div class="welcome-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 3h18v18H3z"></path>
                                <path d="M9 14v1M9 19v-2M15 14v1M15 19v-2M9 8.5v-1M15 8.5v-1"></path>
                                <path d="M12 12a3 3 0 100-6 3 3 0 000 6z"></path>
                            </svg>
                        </div>
                        <h1 class="welcome-title">Welcome to DataTrellis</h1>
                        <p class="welcome-subtitle">A specialized tool in your G.A.R.D.E.N. ecosystem for cultivating insights from structured data</p>
                        
                        <div class="features-list">
                            <div class="feature-item">
                                <div class="feature-icon">üìä</div>
                                <h3 class="feature-title">Analyze Multiple Files</h3>
                                <p>Upload multiple CSV files and easily switch between them for comparative analysis</p>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">üîç</div>
                                <h3 class="feature-title">Search & Filter</h3>
                                <p>Quickly find the data you need with powerful filtering tools across any column</p>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">üß©</div>
                                <h3 class="feature-title">Extensible with Plugins</h3>
                                <p>Add new visualization tools to gain deeper insights from your data</p>
                            </div>
                        </div>
                        
                        <div class="drop-zone" id="drop-zone">
                            <svg class="drop-zone-icon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <div class="drop-zone-text">
                                <h3>Plant Your Data Seeds Here</h3>
                                <p>Drag & drop your CSV files or click to browse</p>
                            </div>
                            <input type="file" id="file-upload" accept=".csv" multiple />
                            <button class="drop-zone-button">Browse Files</button>
                        </div>
                    </div>
                </div>

                <!-- Data view (initially hidden) -->
                <div id="data-view" class="hidden">
                    <!-- File tabs for multiple CSVs -->
                    <div class="file-tabs" id="file-tabs">
                        <!-- Tabs will be added dynamically -->
                        <div class="add-file-tab" id="add-file-tab">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add File
                        </div>
                    </div>

                    <!-- View selector for visualization options -->
                    <div class="view-selector" id="view-selector">
                        <div class="view-selector-option active" data-view="table">Table View</div>
                        <!-- Additional view options will be added by plugins -->
                    </div>

                    <!-- Controls Section -->
                    <div class="navbar">
                        <div class="control-group">
                            <label for="field">Search Column:</label>
                            <select id="field" aria-label="Search Column">
                                <option value="">-- Select column --</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="search">Search Term:</label>
                            <div class="search-container">
                                <input type="text" id="search" placeholder="Enter search terms..." aria-label="Search Term">
                                <button class="clear-button" id="clear-search" title="Clear search">‚úï</button>
                            </div>
                        </div>
                        
                        <div class="control-actions">
                            <button id="run-filter">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                                Search
                            </button>
                            <button id="download-csv">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                Download CSV
                            </button>
                        </div>
                    </div>

                    <!-- Results header and summary -->
                    <div class="results-header mb-1">
                        <div class="results-summary" id="results-summary">Showing all rows</div>
                    </div>

                    <!-- Visualization container (for plugin views) -->
                    <div id="visualization-container" class="visualization-container hidden">
                        <!-- Visualization content will be added by plugins -->
                        <div class="visualization-placeholder" id="visualization-placeholder">
                            Select a visualization plugin to view your data
                        </div>
                    </div>

                    <!-- Default table view -->
                    <div id="table-view">
                        <!-- Data table with stats in header -->
                        <div class="stats-summary" id="stats-summary">
                            <div class="stats-item">
                                <span>Rows:</span>
                                <span class="stats-value" id="visible-rows">-</span>
                                <span>of</span>
                                <span class="stats-value" id="total-rows">-</span>
                            </div>
                            <div class="stats-item">
                                <span>Columns:</span>
                                <span class="stats-value" id="total-columns">-</span>
                            </div>
                            <div class="stats-item">
                                <span>File Size:</span>
                                <span class="stats-value" id="file-size">-</span>
                            </div>
                        </div>

                        <div class="table-container">
                            <table id="data-table">
                                <thead>
                                    <tr>
                                        <!-- Table headers will be populated dynamically -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Table data will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Plugin Template Modal -->
    <div class="template-modal-backdrop" id="template-modal">
        <div class="template-modal">
            <div class="template-modal-header">
                <h3 class="template-modal-title">Plugin Template</h3>
                <button class="template-modal-close" id="template-modal-close">&times;</button>
            </div>
            <div class="template-modal-body">
                <p>Use this template as a starting point for creating your own visualization plugins:</p>
                <pre class="template-code">/**
 * Simple Visualization Plugin Template
 * This template demonstrates the basic structure of a DataTrellis plugin
 */

const MyVisualizationPlugin = {
    // Plugin metadata
    id: 'my-visualization',
    name: 'My Visualization',
    description: 'A custom visualization for DataTrellis',
    author: 'Your Name',
    version: '1.0.0',
    
    // Plugin state
    enabled: true,
    eventSubscriptions: [],
    
    // Initialization function - called when plugin is registered
    init: function() {
        // Register the visualization view
        this.registerViews();
        
        // Set up event listeners
        this.setupEventListeners();
        
        console.log('My visualization plugin initialized');
        return true;
    },
    
    // Register plugin views
    registerViews: function() {
        // Create visualization view
        const myView = {
            id: 'my-visualization-view',
            name: 'My Visualization',
            plugin: this,
            
            // Called when view is activated
            activate: function() {
                // Show visualization container
                const vizContainer = document.getElementById('visualization-container');
                const placeholder = document.getElementById('visualization-placeholder');
                
                if (vizContainer) {
                    vizContainer.classList.remove('hidden');
                }
                
                if (placeholder) {
                    placeholder.classList.add('hidden');
                }
                
                // Create visualization controls
                this.plugin.createVisualizationControls();
                
                // Render visualization
                this.plugin.renderVisualization();
                
                return true;
            },
            
            // Called when view is deactivated
            deactivate: function() {
                // Hide visualization container
                const vizContainer = document.getElementById('visualization-container');
                if (vizContainer) {
                    vizContainer.classList.add('hidden');
                }
                
                return true;
            }
        };
        
        // Register the view
        sandbox.AppRegistry.register('views', myView.id, myView);
    },
    
    // Set up event listeners
    setupEventListeners: function() {
        this.eventSubscriptions = [
            // Listen for file changes
            sandbox.EventBus.subscribe('state:activeFileChanged', (data) => {
                if (sandbox.AppState.getActiveView() === 'my-visualization-view') {
                    this.renderVisualization();
                }
            }),
            
            // Listen for data filtering
            sandbox.EventBus.subscribe('state:dataFiltered', (data) => {
                if (sandbox.AppState.getActiveView() === 'my-visualization-view') {
                    this.renderVisualization();
                }
            })
        ];
    },
    
    // Create visualization controls
    createVisualizationControls: function() {
        const vizContainer = document.getElementById('visualization-container');
        if (!vizContainer) return;
        
        // Clear existing content
        vizContainer.innerHTML = '';
        
        // Add your control elements here
        const controlPanel = document.createElement('div');
        controlPanel.className = 'visualization-controls';
        controlPanel.style.padding = '1rem';
        controlPanel.style.marginBottom = '1rem';
        controlPanel.style.backgroundColor = 'white';
        controlPanel.style.borderRadius = 'var(--radius)';
        
        controlPanel.innerHTML = `
            <h3>My Visualization Controls</h3>
            <p>Add your control elements here</p>
        `;
        
        // Create visualization area
        const visualizationArea = document.createElement('div');
        visualizationArea.id = 'my-visualization-area';
        visualizationArea.style.height = '400px';
        visualizationArea.style.backgroundColor = 'white';
        visualizationArea.style.borderRadius = 'var(--radius)';
        visualizationArea.style.padding = '1rem';
        
        // Add elements to container
        vizContainer.appendChild(controlPanel);
        vizContainer.appendChild(visualizationArea);
    },
    
    // Render visualization
    renderVisualization: function() {
        const visualizationArea = document.getElementById('my-visualization-area');
        if (!visualizationArea) return;
        
        // Get active file data
        const activeFile = sandbox.AppState.getActiveFile();
        if (!activeFile || !activeFile.currentData || !activeFile.currentData.length) {
            visualizationArea.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-500);">No data available</div>';
            return;
        }
        
        // Render your visualization here
        visualizationArea.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <h3>My Visualization</h3>
                <p>Showing ${activeFile.currentData.length} records from ${activeFile.fileName}</p>
                <p>Replace this with your actual visualization code</p>
            </div>
        `;
    },
    
    // Enable plugin
    enable: function() {
        this.enabled = true;
    },
    
    // Disable plugin
    disable: function() {
        this.enabled = false;
    },
    
    // Clean up when plugin is unregistered
    cleanup: function() {
        // Unsubscribe from events
        if (this.eventSubscriptions) {
            this.eventSubscriptions.forEach(sub => sub.unsubscribe());
        }
        
        // Unregister views
        sandbox.AppRegistry.unregister('views', 'my-visualization-view');
    }
};

// Register the plugin
sandbox.registerPlugin(MyVisualizationPlugin);</pre>
            </div>
            <div class="template-modal-footer">
                <button id="copy-template-btn" class="button">Copy Template</button>
                <button id="template-modal-close-btn" class="button secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Plugin Manager Modal -->
    <div class="modal-backdrop" id="plugin-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Plugin Manager</h3>
                <button class="modal-close" id="plugin-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="plugin-section">
                    <div class="plugin-header">
                        <h4>Installed Plugins</h4>
                    </div>
                    <div class="plugin-list" id="plugin-list">
                        <!-- Plugin list will be populated dynamically -->
                        <div class="plugin-card">
                            <div class="plugin-card-header">
                                <h5 class="plugin-name">Table View</h5>
                                <span class="plugin-version">v1.0</span>
                            </div>
                            <p class="plugin-description">Default table view for CSV data</p>
                            <div class="plugin-author">By: DataTrellis</div>
                            <div class="plugin-actions">
                                <span class="plugin-badge active">Built-in</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="plugin-upload">
                        <h4>Add New Plugin</h4>
                        <p>Upload a JavaScript plugin file (.js) to add new functionality</p>
                        
                        <div class="plugin-drop-zone" id="plugin-drop-zone">
                            <p>Drag & drop plugin file here or click to browse</p>
                            <input type="file" id="plugin-file-upload" accept=".js" class="hidden" />
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <div>
                                <button id="browse-plugin-button" class="secondary">Browse Files</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="plugin-modal-cancel" class="secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for "Add File" button -->
    <input type="file" id="add-file-input" accept=".csv" multiple class="hidden" />

    <!-- Loading overlay (initially hidden) -->
    <div class="loading-overlay hidden" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        /**
         * DataTrellis: An Enhanced CSV Explorer with Plugin Architecture
         * 
         * A modular browser-based tool for viewing and analyzing CSV files
         * Built with a constructivist approach to enable clear learning paths
         * and extensibility through plugins.
         */
        
        // ===================================================
        // APPLICATION REGISTRY - Central manager for components
        // ===================================================
        
        const AppRegistry = {
            /**
             * Registry of all system components and plugins
             */
            components: {
                core: {},       // Core system components
                plugins: {},    // Loaded plugins
                views: {},      // Visualization views
                extensions: {}  // UI extensions
            },
            
            /**
             * Register a component in the registry
             * 
             * @param {string} type - Component type (core, plugin, view, extension)
             * @param {string} id - Unique identifier for the component
             * @param {Object} component - The component to register
             * @returns {boolean} - Success status
             */
            register: function(type, id, component) {
                // Ensure valid type
                if (!this.components[type]) {
                    console.error(`Invalid component type: ${type}`);
                    return false;
                }
                
                // Check for duplicate
                if (this.components[type][id]) {
                    console.error(`Component with ID "${id}" already registered in ${type}`);
                    return false;
                }
                
                // Register component
                this.components[type][id] = component;
                
                // Notify listeners about the registration
                EventBus.publish('registry:componentAdded', { type, id, component });
                
                return true;
            },
            
            /**
             * Get a component from the registry
             * 
             * @param {string} type - Component type (core, plugin, view, extension)
             * @param {string} id - Component identifier
             * @returns {Object|null} - The component or null if not found
             */
            get: function(type, id) {
                if (!this.components[type] || !this.components[type][id]) {
                    return null;
                }
                
                return this.components[type][id];
            },
            
            /**
             * Get all components of a specific type
             * 
             * @param {string} type - Component type (core, plugin, view, extension)
             * @returns {Object} - Dictionary of components
             */
            getAll: function(type) {
                return this.components[type] || {};
            },
            
            /**
             * Remove a component from the registry
             * 
             * @param {string} type - Component type (core, plugin, view, extension)
             * @param {string} id - Component identifier
             * @returns {boolean} - Success status
             */
            unregister: function(type, id) {
                if (!this.components[type] || !this.components[type][id]) {
                    return false;
                }
                
                // Store component reference
                const component = this.components[type][id];
                
                // Remove component
                delete this.components[type][id];
                
                // Notify listeners
                EventBus.publish('registry:componentRemoved', { type, id, component });
                
                return true;
            },
            
            /**
             * Check if a component exists
             * 
             * @param {string} type - Component type (core, plugin, view, extension)
             * @param {string} id - Component identifier
             * @returns {boolean} - True if component exists
             */
            exists: function(type, id) {
                return !!(this.components[type] && this.components[type][id]);
            }
        };
        
        
        // ===================================================
        // EVENT BUS - Communication between components
        // ===================================================
        
        const EventBus = {
            /**
             * Map of event listeners
             */
            listeners: {},
            
            /**
             * Subscribe to an event
             * 
             * @param {string} event - Event name
             * @param {Function} callback - Event handler
             * @returns {Object} - Subscription object with unsubscribe method
             */
            subscribe: function(event, callback) {
                // Create event array if it doesn't exist
                if (!this.listeners[event]) {
                    this.listeners[event] = [];
                }
                
                // Add callback to listeners
                this.listeners[event].push(callback);
                
                // Return subscription object
                return {
                    unsubscribe: () => {
                        this.listeners[event] = this.listeners[event].filter(
                            listener => listener !== callback
                        );
                    }
                };
            },
            
            /**
             * Publish an event with data
             * 
             * @param {string} event - Event name
             * @param {*} data - Event data
             */
            publish: function(event, data) {
                // Skip if no listeners
                if (!this.listeners[event]) {
                    return;
                }
                
                // Notify all listeners
                this.listeners[event].forEach(callback => {
                    try {
                        callback(data);
                    } catch (error) {
                        console.error(`Error in event listener for ${event}:`, error);
                    }
                });
            },
            
            /**
             * Clear all listeners for an event
             * 
             * @param {string} event - Event name
             */
            clear: function(event) {
                this.listeners[event] = [];
            }
        };
        
        
        // ===================================================
        // APP STATE - Core data management
        // ===================================================
        
        const AppState = {
            /**
             * Current application state
             */
            state: {
                // Collection of loaded files
                files: [],
                
                // Index of currently active file
                activeFileIndex: -1,
                
                // Current search state
                lastSearch: {
                    field: '',
                    term: ''
                },
                
                // Current active view
                activeView: 'table'
            },
            
            /**
             * Initialize the state system
             */
            init: function() {
                // Register with the application registry
                AppRegistry.register('core', 'state', this);
                
                return this;
            },
            
            /**
             * Get the currently active file
             * 
             * @returns {Object|null} - Active file object or null
             */
            getActiveFile: function() {
                if (this.state.activeFileIndex >= 0 && this.state.activeFileIndex < this.state.files.length) {
                    return this.state.files[this.state.activeFileIndex];
                }
                return null;
            },
            
            /**
             * Get all loaded files
             * 
             * @returns {Array} - Array of file objects
             */
            getAllFiles: function() {
                return this.state.files;
            },
            
            /**
             * Add a file to the collection
             * 
             * @param {Object} file - File object
             * @returns {number} - Index of the new file
             */
            addFile: function(file) {
                this.state.files.push(file);
                
                // Set as active if it's the first file
                if (this.state.files.length === 1) {
                    this.state.activeFileIndex = 0;
                }
                
                // Notify listeners
                EventBus.publish('state:fileAdded', { 
                    file, 
                    index: this.state.files.length - 1 
                });
                
                return this.state.files.length - 1;
            },
            
            /**
             * Remove a file from the collection
             * 
             * @param {number} index - File index
             */
            removeFile: function(index) {
                if (index >= 0 && index < this.state.files.length) {
                    // Store file reference for event
                    const file = this.state.files[index];
                    
                    // Remove file
                    this.state.files.splice(index, 1);
                    
                    // Update active file index if needed
                    let newActiveIndex = this.state.activeFileIndex;
                    
                    if (this.state.files.length === 0) {
                        newActiveIndex = -1;
                    } else if (this.state.activeFileIndex >= this.state.files.length) {
                        newActiveIndex = this.state.files.length - 1;
                    } else if (this.state.activeFileIndex === index) {
                        // Keep the same index unless it was the removed file
                        newActiveIndex = Math.max(0, index - 1);
                    }
                    
                    const activeIndexChanged = newActiveIndex !== this.state.activeFileIndex;
                    this.state.activeFileIndex = newActiveIndex;
                    
                    // Notify listeners
                    EventBus.publish('state:fileRemoved', { 
                        file, 
                        index,
                        activeFileChanged: activeIndexChanged,
                        newActiveIndex
                    });
                }
            },
            
            /**
             * Set the active file by index
             * 
             * @param {number} index - File index
             */
            setActiveFile: function(index) {
                if (index >= 0 && index < this.state.files.length && index !== this.state.activeFileIndex) {
                    const previousIndex = this.state.activeFileIndex;
                    this.state.activeFileIndex = index;
                    this.state.lastSearch = { field: '', term: '' };
                    
                    // Notify listeners
                    EventBus.publish('state:activeFileChanged', {
                        previousIndex,
                        newIndex: index,
                        file: this.state.files[index]
                    });
                }
            },
            
            /**
             * Update filtered data for active file
             * 
             * @param {Array} filteredData - Filtered data array
             * @param {string} searchField - Search field name
             * @param {string} searchTerm - Search term
             */
            setFilteredData: function(filteredData, searchField, searchTerm) {
                const activeFile = this.getActiveFile();
                if (activeFile) {
                    const previousData = activeFile.currentData;
                    activeFile.currentData = filteredData;
                    
                    // Update search state
                    if (searchField !== undefined) {
                        this.state.lastSearch.field = searchField;
                        this.state.lastSearch.term = searchTerm;
                    }
                    
                    // Notify listeners
                    EventBus.publish('state:dataFiltered', {
                        file: activeFile,
                        previousData,
                        newData: filteredData,
                        searchField,
                        searchTerm
                    });
                }
            },
            
            /**
             * Set the active view
             * 
             * @param {string} viewId - View identifier
             */
            setActiveView: function(viewId) {
                if (this.state.activeView !== viewId) {
                    const previousView = this.state.activeView;
                    this.state.activeView = viewId;
                    
                    // Notify listeners
                    EventBus.publish('state:viewChanged', {
                        previousView,
                        newView: viewId
                    });
                }
            },
            
            /**
             * Get the active view ID
             * 
             * @returns {string} - Active view ID
             */
            getActiveView: function() {
                return this.state.activeView;
            },
            
            /**
             * Reset to initial state
             */
            reset: function() {
                const oldState = {...this.state};
                
                this.state.files = [];
                this.state.activeFileIndex = -1;
                this.state.lastSearch = { field: '', term: '' };
                this.state.activeView = 'table';
                
                // Notify listeners
                EventBus.publish('state:reset', {
                    previousState: oldState,
                    newState: {...this.state}
                });
            }
        };
        
        
        // ===================================================
        // THEME MANAGER - Handle theme switching
        // ===================================================
        
        const ThemeManager = {
            /**
             * Initialize the theme manager
             */
            init: function() {
                // Register with app registry
                AppRegistry.register('core', 'themeManager', this);
                
                // Check for saved theme
                const savedTheme = localStorage.getItem('datatrellis-theme');
                if (savedTheme === 'dark') {
                    this.enableDarkTheme();
                }
                
                // Set up event listener for theme toggle
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => {
                        this.toggleTheme();
                    });
                }
                
                return this;
            },
            
            /**
             * Toggle between light and dark themes
             */
            toggleTheme: function() {
                const isDark = document.documentElement.classList.contains('dark-theme');
                
                if (isDark) {
                    this.enableLightTheme();
                } else {
                    this.enableDarkTheme();
                }
            },
            
            /**
             * Enable dark theme
             */
            enableDarkTheme: function() {
                document.documentElement.classList.add('dark-theme');
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.classList.add('dark');
                }
                localStorage.setItem('datatrellis-theme', 'dark');
                
                // Notify system of theme change
                EventBus.publish('theme:changed', { theme: 'dark' });
            },
            
            /**
             * Enable light theme
             */
            enableLightTheme: function() {
                document.documentElement.classList.remove('dark-theme');
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.classList.remove('dark');
                }
                localStorage.setItem('datatrellis-theme', 'light');
                
                // Notify system of theme change
                EventBus.publish('theme:changed', { theme: 'light' });
            }
        };
        
        
        // ===================================================
        // UTILITIES - Helper functions
        // ===================================================
        
        const Utils = {
            /**
             * Initialize the utilities system
             */
            init: function() {
                // Register with the application registry
                AppRegistry.register('core', 'utils', this);
                
                return this;
            },
            
            /**
             * Format a file size in bytes to a human-readable string
             * 
             * @param {number} bytes - File size in bytes
             * @returns {string} - Formatted file size
             */
            formatFileSize: function(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },
            
            /**
             * Generate a shortened file name for display
             * 
             * @param {string} name - Original file name
             * @param {number} maxLength - Maximum length
             * @returns {string} - Shortened file name
             */
            shortenFileName: function(name, maxLength = 20) {
                if (!name) return '';
                if (name.length <= maxLength) return name;
                
                const extension = name.split('.').pop();
                const baseName = name.substring(0, name.length - extension.length - 1);
                
                if (baseName.length <= maxLength - 5) {
                    return baseName + '.' + extension;
                }
                
                // Shorten the name, preserving extension
                return baseName.substring(0, maxLength - 5) + '...' + '.' + extension;
            },
            
            /**
             * Check if a value is likely numeric
             * 
             * @param {*} value - Value to check
             * @returns {boolean} - True if value is numeric
             */
            isNumeric: function(value) {
                // Handle various formats of numbers
                if (typeof value === 'number') return true;
                
                // Handle string representations
                if (typeof value !== 'string') return false;
                
                // Remove common formatting for detection
                const cleanValue = value.replace(/[$,%]/g, '');
                return !isNaN(parseFloat(cleanValue)) && isFinite(cleanValue);
            },
            
            /**
             * Parse a value to a number if possible
             * 
             * @param {*} value - Value to parse
             * @returns {number} - Parsed number or 0
             */
            parseNumeric: function(value) {
                if (typeof value === 'number') return value;
                if (!value) return 0;
                
                // Clean the value of formatting characters
                const cleanValue = String(value).replace(/[$,%]/g, '');
                return parseFloat(cleanValue);
            },
            
            /**
             * Parse a range expression like [10,20]
             * 
             * @param {string} value - Range expression
             * @returns {Object|null} - {min, max} object or null
             */
            parseRange: function(value) {
                const rangeMatch = String(value).match(/^\[(\d*\.?\d*),(\d*\.?\d*)\]$/);
                if (!rangeMatch) return null;
                
                return {
                    min: rangeMatch[1] ? parseFloat(rangeMatch[1]) : -Infinity,
                    max: rangeMatch[2] ? parseFloat(rangeMatch[2]) : Infinity
                };
            },
            
            /**
             * Convert a value to CSV-safe string
             * 
             * @param {*} value - Value to convert
             * @returns {string} - CSV-safe string
             */
            toCsvValue: function(value) {
                if (value === null || value === undefined) return '';
                
                // Convert to string
                const str = String(value);
                
                // Check if we need to quote this value
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    // Escape quotes by doubling them and wrap in quotes
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                
                return str;
            },
            
            /**
             * Convert data to CSV string
             * 
             * @param {Array} headers - Column headers
             * @param {Array} data - Data rows
             * @returns {string} - CSV string
             */
            convertToCSV: function(headers, data) {
                // Start with headers
                let csv = headers.map(this.toCsvValue).join(',') + '\n';
                
                // Add each row
                data.forEach(row => {
                    const csvRow = headers.map(header => this.toCsvValue(row[header])).join(',');
                    csv += csvRow + '\n';
                });
                
                return csv;
            },
            
            /**
             * Generate a filename for download based on original
             /**
             * Generate a filename for download based on original name
             * 
             * @param {string} originalName - Original file name
             * @returns {string} - Generated file name
             */
            generateFilename: function(originalName) {
                // Extract base name without extension
                const baseName = originalName.replace(/\.[^/.]+$/, "");
                
                // Create a date string in YYYY-MM-DD format
                const now = new Date();
                const date = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                
                // Create a clean filename
                return `${baseName}_filtered_${date}.csv`;
            },
            
            /**
             * Find common column names across files
             * 
             * @param {Array} files - Array of file objects
             * @returns {Array} - Array of common column names
             */
            findCommonColumns: function(files) {
                if (!files || !files.length) return [];
                
                // Start with the columns from the first file
                let commonColumns = [...files[0].headers];
                
                // Intersect with columns from each additional file
                for (let i = 1; i < files.length; i++) {
                    const fileColumns = files[i].headers;
                    commonColumns = commonColumns.filter(col => fileColumns.includes(col));
                }
                
                return commonColumns;
            },
            
            /**
             * Create an element with attributes and content
             * 
             * @param {string} tag - Element tag name
             * @param {Object} attributes - Element attributes
             * @param {Array|string} children - Child elements or text
             * @returns {HTMLElement} - Created element
             */
            createElement: function(tag, attributes = {}, children = []) {
                const element = document.createElement(tag);
                
                // Add attributes
                Object.keys(attributes).forEach(key => {
                    if (key === 'style' && typeof attributes[key] === 'object') {
                        Object.assign(element.style, attributes[key]);
                    } else if (key === 'text') {
                        element.textContent = attributes[key];
                    } else if (key === 'html') {
                        element.innerHTML = attributes[key];
                    } else if (key.startsWith('on') && typeof attributes[key] === 'function') {
                        element.addEventListener(key.slice(2).toLowerCase(), attributes[key]);
                    } else {
                        element.setAttribute(key, attributes[key]);
                    }
                });
                
                // Add children
                if (Array.isArray(children)) {
                    children.forEach(child => {
                        if (typeof child === 'string') {
                            element.appendChild(document.createTextNode(child));
                        } else if (child instanceof Node) {
                            element.appendChild(child);
                        }
                    });
                } else if (typeof children === 'string') {
                    element.textContent = children;
                }
                
                return element;
            }
        };
        
        
        // ===================================================
        // CSV PROCESSING - Parsing and manipulation
        // ===================================================
        
        const CsvProcessor = {
            /**
             * Initialize the CSV processor system
             */
            init: function() {
                // Register with the application registry
                AppRegistry.register('core', 'csvProcessor', this);
                
                return this;
            },
            
            /**
             * Parse a CSV string into headers and data objects
             * 
             * @param {string} csvString - CSV data as string
             * @returns {Promise} - Promise resolving to {headers, data}
             */
            parseCSV: function(csvString) {
                return new Promise((resolve, reject) => {
                    try {
                        // Split into lines
                        const lines = csvString.split(/\r\n|\n|\r/).filter(line => line.trim());
                        
                        if (lines.length === 0) {
                            reject(new Error("CSV file appears to be empty"));
                            return;
                        }
                        
                        // Parse headers (first line)
                        const headers = this.parseCSVLine(lines[0]);
                        
                        // Parse data rows
                        const data = [];
                        for (let i = 1; i < lines.length; i++) {
                            const values = this.parseCSVLine(lines[i]);
                            
                            // Skip lines that don't match header length
                            if (values.length !== headers.length) continue;
                            
                            // Create an object with header keys
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index];
                            });
                            
                            data.push(row);
                        }
                        
                        resolve({ headers, data });
                    } catch (error) {
                        reject(error);
                    }
                });
            },
            
            /**
             * Parse a single CSV line, handling quoted values
             * 
             * @param {string} line - CSV line
             * @returns {Array} - Array of values
             */
            parseCSVLine: function(line) {
                const result = [];
                let currentValue = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        // Handle double quotes inside quoted strings
                        if (inQuotes && nextChar === '"') {
                            currentValue += '"';
                            i++; // Skip the next quote
                        } else {
                            // Toggle quote mode
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // End of value
                        result.push(currentValue);
                        currentValue = '';
                    } else {
                        // Add character to current value
                        currentValue += char;
                    }
                }
                
                // Add the last value
                result.push(currentValue);
                
                return result;
            },
            
            /**
             * Detect column types from sample data
             * 
             * @param {Array} headers - Column headers
             * @param {Array} data - Data rows
             * @param {number} sampleSize - Number of rows to sample
             * @returns {Object} - Column types by header
             */
            detectColumnTypes: function(headers, data, sampleSize = 10) {
                const types = {};
                const samples = data.slice(0, sampleSize);
                
                headers.forEach(header => {
                    // Check if column contains numeric values
                    const numericCount = samples.reduce((count, row) => {
                        return Utils.isNumeric(row[header]) ? count + 1 : count;
                    }, 0);
                    
                    // If more than 70% of samples are numeric, consider it numeric
                    types[header] = (numericCount / samples.length > 0.7) ? 'numeric' : 'text';
                });
                
                return types;
            }
        };
        
        
        // ===================================================
        // FILTER SYSTEM - Search and filtering
        // ===================================================
        
        const FilterSystem = {
            /**
             * Initialize the filter system
             */
            init: function() {
                // Register with the application registry
                AppRegistry.register('core', 'filterSystem', this);
                
                return this;
            },
            
            /**
             * Create a filter template
             * 
             * @param {string} field - Field to filter
             * @param {string} operator - Filter operator
             * @param {*} value - Filter value
             * @returns {Object} - Filter object
             */
            createFilter: function(field, operator, value) {
                return {
                    field: field,
                    operator: operator,
                    value: value,
                    
                    // Apply this filter to a single record
                    applyTo: function(record) {
                        const fieldValue = record[this.field];
                        
                        switch (this.operator) {
                            case 'contains':
                                return String(fieldValue).toLowerCase()
                                    .includes(String(this.value).toLowerCase());
                                
                            case 'equals':
                                return String(fieldValue).toLowerCase() === 
                                    String(this.value).toLowerCase();
                                
                            case 'range':
                                if (!Utils.isNumeric(fieldValue)) return false;
                                const numValue = Utils.parseNumeric(fieldValue);
                                return numValue >= this.value.min && numValue <= this.value.max;
                                
                            default:
                                return true;
                        }
                    }
                };
            },
            
            /**
             * Create a filter from search input
             * 
             * @param {string} fieldName - Field name
             * @param {string} searchTerm - Search term
             * @returns {Object|null} - Filter object or null
             */
            createFromSearch: function(fieldName, searchTerm) {
                // Handle empty search
                if (!searchTerm || !fieldName) return null;
                
                // Get currently active file
                const activeFile = AppState.getActiveFile();
                if (!activeFile || !activeFile.rawData || !activeFile.rawData.length) {
                    return null;
                }
                
                const sampleRow = activeFile.rawData[0];
                const sampleValue = sampleRow[fieldName];
                
                // Check for range search on numeric fields
                if (Utils.isNumeric(sampleValue)) {
                    const range = Utils.parseRange(searchTerm);
                    if (range) {
                        return this.createFilter(fieldName, 'range', range);
                    }
                }
                
                // Default to contains search
                return this.createFilter(fieldName, 'contains', searchTerm);
            },
            
            /**
             * Apply a filter to a dataset
             * 
             * @param {Array} data - Data array
             * @param {Object} filter - Filter object
             * @returns {Array} - Filtered data
             */
            applyFilter: function(data, filter) {
                if (!filter) return data;
                
                return data.filter(record => filter.applyTo(record));
            }
        };
        
        
        // ===================================================
        // DOM UI MANAGER - User interface management
        // ===================================================
        
        const DomUI = {
            /**
             * UI element references
             */
            elements: {},
            
            /**
             * Initialize the DOM UI system
             */
            init: function() {
                // Register with the application registry
                AppRegistry.register('core', 'domUI', this);
                
                // Bind DOM elements
                this.bindElements();
                
                // Listen for events
                this.setupEventListeners();
                
                // Set up event subscriptions
                this.setupSubscriptions();
                
                return this;
            },
            
            /**
             * Bind DOM elements to the elements object
             */
            bindElements: function() {
                // Core elements
                const elementIds = [
                    'drop-zone', 'file-upload', 'data-view', 'upload-section',
                    'file-tabs', 'add-file-tab', 'add-file-input', 'loading-overlay',
                    'view-selector', 'field', 'search', 'clear-search',
                    'run-filter', 'download-csv', 'results-summary', 'stats-summary',
                    'visible-rows', 'total-rows', 'total-columns', 'file-size',
                    'data-table', 'plugin-drawer', 'drawer-toggle', 'main-container',
                    'theme-toggle', 'visualization-container', 'visualization-placeholder',
                    'table-view', 'plugin-modal', 'plugin-modal-close', 'plugin-modal-cancel',
                    'plugin-list', 'plugin-drop-zone', 'plugin-file-upload',
                    'browse-plugin-button', 'add-plugin-btn', 'template-modal',
                    'template-modal-close', 'template-modal-close-btn', 'copy-template-btn',
                    'view-template-btn'
                ];
                
                elementIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        this.elements[id] = element;
                    }
                });
            },
            
            /**
             * Set up event listeners for UI elements
             */
            setupEventListeners: function() {
                // Drawer toggle
                if (this.elements['drawer-toggle'] && this.elements['plugin-drawer'] && this.elements['main-container']) {
                    this.elements['drawer-toggle'].addEventListener('click', () => {
                        this.elements['plugin-drawer'].classList.toggle('open');
                        this.elements['main-container'].classList.toggle('drawer-open');
                    });
                }
                
                // File upload handlers
                if (this.elements['drop-zone'] && this.elements['file-upload']) {
                    const dropZone = this.elements['drop-zone'];
                    const fileUpload = this.elements['file-upload'];
                    
                    // Drag and drop handlers
                    dropZone.addEventListener('dragover', e => {
                        e.preventDefault();
                        e.stopPropagation();
                        dropZone.classList.add('dragover');
                    });
                    
                    dropZone.addEventListener('dragleave', e => {
                        e.preventDefault();
                        e.stopPropagation();
                        dropZone.classList.remove('dragover');
                    });
                    
                    dropZone.addEventListener('drop', e => {
                        e.preventDefault();
                        e.stopPropagation();
                        dropZone.classList.remove('dragover');
                        
                        // Handle the dropped files
                        if (e.dataTransfer.files.length) {
                            FileHandler.processFiles(e.dataTransfer.files);
                        }
                    });
                    
                    // Click to browse
                    dropZone.addEventListener('click', () => {
                        fileUpload.click();
                    });
                    
                    // File input change
                    fileUpload.addEventListener('change', function() {
                        if (this.files.length) {
                            FileHandler.processFiles(this.files);
                        }
                    });
                }
                
                // Add file tab and input
                if (this.elements['add-file-tab'] && this.elements['add-file-input']) {
                    const addFileTab = this.elements['add-file-tab'];
                    const addFileInput = this.elements['add-file-input'];
                    
                    addFileTab.addEventListener('click', () => {
                        addFileInput.click();
                    });
                    
                    addFileInput.addEventListener('change', function() {
                        if (this.files.length) {
                            FileHandler.processFiles(this.files);
                        }
                    });
                }
                
                // File tabs click delegation
                if (this.elements['file-tabs']) {
                    this.elements['file-tabs'].addEventListener('click', e => {
                        const target = e.target;
                        
                        // Handle close button click
                        if (target.classList.contains('file-tab-close')) {
                            const index = parseInt(target.getAttribute('data-index'));
                            FileHandler.closeFile(index);
                            return;
                        }
                        
                        // Handle tab selection
                        if (target.classList.contains('file-tab')) {
                            const index = parseInt(target.getAttribute('data-index'));
                            FileHandler.switchFile(index);
                            return;
                        }
                    });
                }
                
                // View selector click delegation
                if (this.elements['view-selector']) {
                    this.elements['view-selector'].addEventListener('click', e => {
                        const target = e.target;
                        
                        if (target.classList.contains('view-selector-option')) {
                            const viewId = target.getAttribute('data-view');
                            ViewController.activateView(viewId);
                        }
                    });
                }
                
                // Plugin drawer items
                this.setupPluginDrawerEvents();
                
                // Filter controls
                if (this.elements['run-filter']) {
                    this.elements['run-filter'].addEventListener('click', () => {
                        App.runFilter();
                    });
                }
                
                if (this.elements['clear-search']) {
                    this.elements['clear-search'].addEventListener('click', () => {
                        App.clearSearch();
                    });
                }
                
                // CSV download
                if (this.elements['download-csv']) {
                    this.elements['download-csv'].addEventListener('click', () => {
                        FileHandler.downloadCSV();
                    });
                }
                
                // Template modal controls
                this.setupTemplateModalEvents();
                
                // Plugin manager modal
                this.setupPluginManagerEvents();
            },
            
            /**
             * Set up events for plugin drawer items
             */
            setupPluginDrawerEvents: function() {
                // View items
                document.querySelectorAll('.plugin-item[data-view]').forEach(item => {
                    item.addEventListener('click', function() {
                        const viewId = this.getAttribute('data-view');
                        if (viewId && ViewController) {
                            ViewController.activateView(viewId);
                            
                            // Update active state
                            document.querySelectorAll('.plugin-item').forEach(el => {
                                el.classList.remove('active');
                            });
                            this.classList.add('active');
                        }
                    });
                });
                
                // Add plugin button
                if (this.elements['add-plugin-btn']) {
                    this.elements['add-plugin-btn'].addEventListener('click', () => {
                        PluginManager.openManager();
                    });
                }
                
                // Template button
                if (this.elements['view-template-btn']) {
                    this.elements['view-template-btn'].addEventListener('click', () => {
                        this.showTemplateModal();
                    });
                }
            },
            
            /**
             * Set up template modal events
             */
            setupTemplateModalEvents: function() {
                if (this.elements['template-modal-close']) {
                    this.elements['template-modal-close'].addEventListener('click', () => {
                        this.hideTemplateModal();
                    });
                }
                
                if (this.elements['template-modal-close-btn']) {
                    this.elements['template-modal-close-btn'].addEventListener('click', () => {
                        this.hideTemplateModal();
                    });
                }
                
                if (this.elements['copy-template-btn']) {
                    this.elements['copy-template-btn'].addEventListener('click', () => {
                        const template = document.querySelector('.template-code').textContent;
                        navigator.clipboard.writeText(template)
                            .then(() => {
                                this.elements['copy-template-btn'].textContent = 'Copied!';
                                setTimeout(() => {
                                    this.elements['copy-template-btn'].textContent = 'Copy Template';
                                }, 2000);
                            });
                    });
                }
            },
            
            /**
             * Set up plugin manager events
             */
            setupPluginManagerEvents: function() {
                // Plugin manager buttons
                if (this.elements['plugin-modal-close']) {
                    this.elements['plugin-modal-close'].addEventListener('click', () => {
                        PluginManager.closeManager();
                    });
                }
                
                if (this.elements['plugin-modal-cancel']) {
                    this.elements['plugin-modal-cancel'].addEventListener('click', () => {
                        PluginManager.closeManager();
                    });
                }
                
                // Plugin upload
                if (this.elements['plugin-drop-zone'] && this.elements['plugin-file-upload']) {
                    const dropZone = this.elements['plugin-drop-zone'];
                    const fileUpload = this.elements['plugin-file-upload'];
                    
                    dropZone.addEventListener('dragover', e => {
                        e.preventDefault();
                        e.stopPropagation();
                        dropZone.classList.add('dragover');
                    });
                    
                    dropZone.addEventListener('dragleave', e => {
                        e.preventDefault();
                        e.stopPropagation();
                        dropZone.classList.remove('dragover');
                    });
                    
                    dropZone.addEventListener('drop', e => {
                        e.preventDefault();
                        e.stopPropagation();
                        dropZone.classList.remove('dragover');
                        
                        // Handle the dropped files
                        if (e.dataTransfer.files.length) {
                            PluginManager.uploadPlugin(e.dataTransfer.files[0]);
                        }
                    });
                    
                    // Click to browse
                    dropZone.addEventListener('click', () => {
                        fileUpload.click();
                    });
                    
                    fileUpload.addEventListener('change', function() {
                        if (this.files.length) {
                            PluginManager.uploadPlugin(this.files[0]);
                        }
                    });
                }
                
                if (this.elements['browse-plugin-button']) {
                    this.elements['browse-plugin-button'].addEventListener('click', () => {
                        this.elements['plugin-file-upload'].click();
                    });
                }
            },
            
            /**
             * Show template modal
             */
            showTemplateModal: function() {
                if (this.elements['template-modal']) {
                    this.elements['template-modal'].classList.add('active');
                }
            },
            
            /**
             * Hide template modal
             */
            hideTemplateModal: function() {
                if (this.elements['template-modal']) {
                    this.elements['template-modal'].classList.remove('active');
                }
            },
            
            /**
             * Set up event bus subscriptions
             */
            setupSubscriptions: function() {
                // Listen for state changes
                EventBus.subscribe('state:fileAdded', () => {
                    this.updateFileTabs();
                });
                
                EventBus.subscribe('state:fileRemoved', () => {
                    this.updateFileTabs();
                });
                
                EventBus.subscribe('state:activeFileChanged', () => {
                    this.updateFileTabs();
                    this.updateSearchFields();
                    this.updateTable();
                    this.updateStats();
                });
                
                EventBus.subscribe('state:dataFiltered', () => {
                    this.updateTable();
                    this.updateStats();
                });
                
                EventBus.subscribe('state:viewChanged', (data) => {
                    this.updateViewSelector(data.newView);
                });
                
                EventBus.subscribe('plugins:registered', () => {
                    this.updatePluginList();
                    this.updateViewSelector();
                });
                
                EventBus.subscribe('plugins:unregistered', () => {
                    this.updatePluginList();
                    this.updateViewSelector();
                });
            },
            
            /**
             * Get an element by ID
             * 
             * @param {string} id - Element ID
             * @returns {HTMLElement} - DOM element
             */
            get: function(id) {
                return document.getElementById(id);
            },
            
            /**
             * Show or hide an element
             * 
             * @param {string|HTMLElement} element - Element or ID
             * @param {boolean} show - Show or hide
             */
            toggle: function(element, show) {
                if (typeof element === 'string') {
                    element = this.get(element);
                }
                
                if (!element) return;
                
                if (show) {
                    element.classList.remove('hidden');
                } else {
                    element.classList.add('hidden');
                }
            },
            
            /**
             * Empty an element
             * 
             * @param {string|HTMLElement} element - Element or ID
             */
            empty: function(element) {
                if (typeof element === 'string') {
                    element = this.get(element);
                }
                
                if (!element) return;
                
                while (element.firstChild) {
                    element.removeChild(element.firstChild);
                }
            },
            
            /**
             * Update file tabs based on loaded files
             */
            updateFileTabs: function() {
                const tabsContainer = this.elements['file-tabs'];
                const addFileTab = this.elements['add-file-tab'];
                
                if (!tabsContainer || !addFileTab) return;
                
                // Remove all tabs except the "Add File" tab
                Array.from(tabsContainer.children).forEach(child => {
                    if (child !== addFileTab) {
                        tabsContainer.removeChild(child);
                    }
                });
                
                // Add tabs for each file
                AppState.getAllFiles().forEach((file, index) => {
                    const isActive = index === AppState.state.activeFileIndex;
                    
                    const tab = Utils.createElement('div', {
                        class: `file-tab${isActive ? ' active' : ''}`,
                        'data-index': index
                    }, [
                        Utils.shortenFileName(file.fileName),
                        Utils.createElement('span', {
                            class: 'file-tab-close',
                            'data-index': index,
                            title: 'Close file'
                        }, '√ó')
                    ]);
                    
                    tabsContainer.insertBefore(tab, addFileTab);
                });
            },
            
            /**
             * Update the search field dropdown based on active file
             */
            updateSearchFields: function() {
                const fieldSelect = this.elements['field'];
                if (!fieldSelect) return;
                
                this.empty(fieldSelect);
                
                // Add placeholder option
                fieldSelect.appendChild(Utils.createElement('option', {
                    value: ''
                }, '-- Select column --'));
                
                // Get currently active file
                const activeFile = AppState.getActiveFile();
                if (activeFile && activeFile.headers) {
                    // Add options for each header
                    activeFile.headers.forEach(header => {
                        fieldSelect.appendChild(Utils.createElement('option', {
                            value: header
                        }, header));
                    });
                }
            },
            
            /**
             * Update table with current data from active file
             */
            updateTable: function() {
                // Only update if table view is active
                if (AppState.getActiveView() !== 'table') return;
                
                const table = this.elements['data-table'];
                if (!table) return;
                
                const thead = table.querySelector('thead tr');
                const tbody = table.querySelector('tbody');
                
                if (!thead || !tbody) return;
                
                // Clear existing content
                this.empty(thead);
                this.empty(tbody);
                
                // Get currently active file
                const activeFile = AppState.getActiveFile();
                if (!activeFile) return;
                
                // Add headers
                activeFile.headers.forEach(header => {
                    thead.appendChild(Utils.createElement('th', {}, header));
                });
                
                // Add data rows
                activeFile.currentData.forEach(row => {
                    const tr = Utils.createElement('tr');
                    
                    activeFile.headers.forEach(header => {
                        tr.appendChild(Utils.createElement('td', {}, String(row[header] || '')));
                    });
                    
                    tbody.appendChild(tr);
                });
            },
            
            /**
             * Update statistics display for active file
             */
            updateStats: function() {
                // Only update stats if elements exist
                if (!this.elements['total-rows'] || 
                    !this.elements['total-columns'] || 
                    !this.elements['visible-rows'] || 
                    !this.elements['file-size'] || 
                    !this.elements['results-summary']) return;
                
                // Get currently active file
                const activeFile = AppState.getActiveFile();
                if (!activeFile) {
                    this.elements['total-rows'].textContent = '-';
                    this.elements['total-columns'].textContent = '-';
                    this.elements['visible-rows'].textContent = '-';
                    this.elements['file-size'].textContent = '-';
                    this.elements['results-summary'].textContent = 'No file selected';
                    return;
                }
                
                // Update stats
                this.elements['total-rows'].textContent = activeFile.rawData.length.toLocaleString();
                this.elements['total-columns'].textContent = activeFile.headers.length.toLocaleString();
                this.elements['visible-rows'].textContent = activeFile.currentData.length.toLocaleString();
                this.elements['file-size'].textContent = Utils.formatFileSize(activeFile.fileSize);
                
                // Update results summary
                let summaryText = `${activeFile.fileName}: showing ${activeFile.currentData.length.toLocaleString()} of ${activeFile.rawData.length.toLocaleString()} rows`;
                
                // Add filter info if available
                if (AppState.state.lastSearch.field && AppState.state.lastSearch.term) {
                    summaryText += ` (filtered by "${AppState.state.lastSearch.field}": "${AppState.state.lastSearch.term}")`;
                }
                
                this.elements['results-summary'].textContent = summaryText;
            },
            
            /**
             * Update plugin list in plugin manager
             */
            updatePluginList: function() {
                const pluginList = this.elements['plugin-list'];
                if (!pluginList) return;
                
                // Clear existing list except for built-in plugins
                Array.from(pluginList.children).forEach(child => {
                    if (!child.querySelector('.plugin-badge.active')) {
                        pluginList.removeChild(child);
                    }
                });
                
                // Add each plugin
                const plugins = AppRegistry.getAll('plugins');
                
                Object.keys(plugins).forEach(pluginId => {
                    const plugin = plugins[pluginId];
                    
                    // Skip if already in list (built-in)
                    const existingPlugin = pluginList.querySelector(`[data-plugin-id="${pluginId}"]`);
                    if (existingPlugin) {
                        return;
                    }
                    
                    const isActive = plugin.enabled !== false;
                    
                    const cardHeader = Utils.createElement('div', { class: 'plugin-card-header' }, [
                        Utils.createElement('h5', { class: 'plugin-name' }, plugin.name || pluginId),
                        Utils.createElement('span', { class: 'plugin-version' }, `v${plugin.version || '1.0'}`)
                    ]);
                    
                    const cardDescription = Utils.createElement('p', { 
                        class: 'plugin-description' 
                    }, plugin.description || 'No description available');
                    
                    const cardAuthor = Utils.createElement('div', { 
                        class: 'plugin-author' 
                    }, `By: ${plugin.author || 'Unknown'}`);
                    
                    const actions = Utils.createElement('div', { class: 'plugin-actions' }, [
                        Utils.createElement('span', { 
                            class: `plugin-badge${isActive ? ' active' : ''}` 
                        }, isActive ? 'Active' : 'Inactive'),
                        Utils.createElement('button', {
                            class: 'secondary',
                            'data-plugin-id': pluginId,
                            'data-action': isActive ? 'disable' : 'enable',
                            onclick: (e) => {
                                const pluginId = e.target.getAttribute('data-plugin-id');
                                const action = e.target.getAttribute('data-action');
                                
                                if (action === 'enable') {
                                    PluginManager.enablePlugin(pluginId);
                                } else {
                                    PluginManager.disablePlugin(pluginId);
                                }
                            }
                        }, isActive ? 'Disable' : 'Enable')
                    ]);
                    
                    const card = Utils.createElement('div', {
                        class: 'plugin-card',
                        'data-plugin-id': pluginId
                    }, [cardHeader, cardDescription, cardAuthor, actions]);
                    
                    pluginList.appendChild(card);
                });
            },
            
            /**
             * Update view selector with available views
             * 
             * @param {string} activeViewId - Active view ID
             */
            updateViewSelector: function(activeViewId) {
                const viewSelector = this.elements['view-selector'];
                if (!viewSelector) return;
                
                // Use provided active view or get from state
                activeViewId = activeViewId || AppState.getActiveView();
                
                // Clear existing options except for built-in table view
                Array.from(viewSelector.children).forEach(child => {
                    if (child.getAttribute('data-view') !== 'table') {
                        viewSelector.removeChild(child);
                    }
                });
                
                // Update active state for table view
                const tableView = viewSelector.querySelector('[data-view="table"]');
                if (tableView) {
                    if (activeViewId === 'table') {
                        tableView.classList.add('active');
                    } else {
                        tableView.classList.remove('active');
                    }
                }
                
                // Add plugin views
                const views = AppRegistry.getAll('views');
                
                Object.keys(views).forEach(viewId => {
                    // Skip table view (already added in HTML)
                    if (viewId === 'table') return;
                    
                    // Skip if already in selector
                    if (viewSelector.querySelector(`[data-view="${viewId}"]`)) {
                        return;
                    }
                    
                    const view = views[viewId];
                    const isActive = activeViewId === viewId;
                    
                    const option = Utils.createElement('div', {
                        class: `view-selector-option${isActive ? ' active' : ''}`,
                        'data-view': viewId
                    }, view.name || viewId);
                    
                    viewSelector.appendChild(option);
                });
            },
            
            /**
             * Show loading overlay
             * 
             * @param {boolean} show - Show or hide
             */
            showLoading: function(show = true) {
                this.toggle('loading-overlay', show);
            },
            
            /**
             * Show a notification message
             * 
             * @param {string} message - Message text
             * @param {string} type - Message type (info, success, warning, error)
             * @param {number} duration - Duration in ms
             */
            showNotification: function(message, type = 'info', duration = 3000) {
                // Use console.log as fallback if no notification system exists
                console.log(`[${type}] ${message}`);
            }
        };
        
        
        // ===================================================
        // FILE HANDLER - Upload, reading, and download
        // ===================================================
        
        const FileHandler = {
            /**
             * Initialize the file handler system
             */
            init: function() {
                // Register with the application registry
                AppRegistry.register('core', 'fileHandler', this);
                
                return this;
            },
            
            /**
             * Process file selection from input or drop
             * 
             * @param {FileList} fileList - List of files
             */
            processFiles: function(fileList) {
                if (!fileList || fileList.length === 0) return;
                
                DomUI.showLoading(true);
                
                // Process each file
                const filePromises = Array.from(fileList).map(file => {
                    // Skip non-CSV files
                    if (!file.name.toLowerCase().endsWith('.csv')) {
                        return Promise.resolve(null);
                    }
                    
                    return this.readAndParseFile(file);
                });
                
                // Process all files
                Promise.all(filePromises)
                    .then(results => {
                        // Filter out null results (skipped files)
                        const validResults = results.filter(result => result !== null);
                        
                        if (validResults.length === 0) {
                            DomUI.showNotification('No valid CSV files were selected', 'warning');
                            DomUI.showLoading(false);
                            return;
                        }
                        
                        // Add each file to the application state
                        let firstFileIndex = -1;
                        validResults.forEach(fileData => {
                            const index = AppState.addFile(fileData);
                            if (firstFileIndex === -1) firstFileIndex = index;
                        });
                        
                        // Switch to data view
                        DomUI.toggle('upload-section', false);
                        DomUI.toggle('data-view', true);
                        
                        // Update UI for the first loaded file
                        DomUI.updateFileTabs();
                        DomUI.updateSearchFields();
                        DomUI.updateTable();
                        DomUI.updateStats();
                        DomUI.showLoading(false);
                        
                        // Notify all active views
                        EventBus.publish('files:loaded', {
                            files: validResults
                        });
                    })
                    .catch(error => {
                        DomUI.showNotification('Error processing files: ' + error.message, 'error');
                        DomUI.showLoading(false);
                    });
            },
            
            /**
             * Read and parse a single CSV file
             * 
             * @param {File} file - File object
             * @returns {Promise} - Promise resolving to file data
             */
            readAndParseFile: function(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const contents = e.target.result;
                        
                        // Parse CSV data
                        CsvProcessor.parseCSV(contents)
                            .then(result => {
                                // Create a file data object
                                const fileData = {
                                    fileName: file.name,
                                    fileSize: file.size,
                                    headers: result.headers,
                                    rawData: result.data,
                                    currentData: result.data,
                                    columnTypes: CsvProcessor.detectColumnTypes(result.headers, result.data)
                                };
                                
                                resolve(fileData);
                            })
                            .catch(error => {
                                reject(error);
                            });
                    };
                    
                    reader.onerror = function() {
                        reject(new Error('Error reading file: ' + file.name));
                    };
                    
                    reader.readAsText(file);
                });
            },
            
            /**
             * Download current data from active file as CSV
             */
            downloadCSV: function() {
                // Get currently active file
                const activeFile = AppState.getActiveFile();
                if (!activeFile || !activeFile.headers.length || !activeFile.currentData.length) {
                    DomUI.showNotification('No data to download', 'warning');
                    return;
                }
                
                // Convert data to CSV
                const csv = Utils.convertToCSV(activeFile.headers, activeFile.currentData);
                
                // Create blob and download link
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = Utils.createElement('a', {
                    href: URL.createObjectURL(blob),
                    download: Utils.generateFilename(activeFile.fileName)
                });
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                DomUI.showNotification('File downloaded successfully', 'success');
            },
            
            /**
             * Close a file by index
             * 
             * @param {number} index - File index
             */
            closeFile: function(index) {
                AppState.removeFile(index);
                
                // If no files left, return to upload screen
                if (AppState.getAllFiles().length === 0) {
                    DomUI.toggle('data-view', false);
                    DomUI.toggle('upload-section', true);
                    return;
                }
                
                // Update UI for the new active file
                DomUI.updateFileTabs();
                DomUI.updateSearchFields();
                DomUI.updateTable();
                DomUI.updateStats();
            },
            
            /**
             * Switch to a different file by index
             * 
             * @param {number} index - File index
             */
            switchFile: function(index) {
                AppState.setActiveFile(index);
                
                // Reset search inputs
                if (DomUI.elements['field']) DomUI.elements['field'].value = '';
                if (DomUI.elements['search']) DomUI.elements['search'].value = '';
            }
        };
        
        
        // ===================================================
        // VIEW CONTROLLER - Manage different data views
        // ===================================================
        
        const ViewController = {
            /**
             * Initialize the view controller system
             */
            init: function() {
                // Register with the application registry
                AppRegistry.register('core', 'viewController', this);
                
                // Register the default table view
                this.registerTableView();
                
                return this;
            },
            
            /**
             * Register the default table view
             */
            registerTableView: function() {
                // Create table view definition
                const tableView = {
                    id: 'table',
                    name: 'Table View',
                    description: 'Default tabular view for CSV data',
                    author: 'DataTrellis',
                    version: '1.0',
                    
                    // Activation handler
                    activate: function() {
                        // Show table view
                        DomUI.toggle('table-view', true);
                        DomUI.toggle('visualization-container', false);
                        
                        // Update table
                        DomUI.updateTable();
                        DomUI.updateStats();
                        
                        return true;
                    },
                    
                    // Deactivation handler
                    deactivate: function() {
                        // Hide table view
                        DomUI.toggle('table-view', false);
                        return true;
                    }
                };
                
                // Register the view
                AppRegistry.register('views', 'table', tableView);
            },
            
            /**
             * Register a new view
             * 
             * @param {Object} view - View definition
             * @returns {boolean} - Success status
             */
            registerView: function(view) {
                // Validate required properties
                if (!view.id || !view.name || !view.activate || !view.deactivate) {
                    console.error('Invalid view definition:', view);
                    return false;
                }
                
                // Register the view
                return AppRegistry.register('views', view.id, view);
            },
            
            /**
             * Unregister a view
             * 
             * @param {string} viewId - View ID
             * @returns {boolean} - Success status
             */
            unregisterView: function(viewId) {
                // Cannot unregister table view
                if (viewId === 'table') {
                    console.error('Cannot unregister built-in table view');
                    return false;
                }
                
                // If current view is being unregistered, switch to table view
                if (AppState.getActiveView() === viewId) {
                    this.activateView('table');
                }
                
                return AppRegistry.unregister('views', viewId);
            },
            
            /**
             * Activate a view by ID
             * 
             * @param {string} viewId - View ID
             * @returns {boolean} - Success status
             */
            activateView: function(viewId) {
                // Get current and new views
                const currentViewId = AppState.getActiveView();
                const newView = AppRegistry.get('views', viewId);
                
                // Validate new view
                if (!newView) {
                    console.error(`View not found: ${viewId}`);
                    return false;
                }
                
                // Skip if already active
                if (currentViewId === viewId) {
                    return true;
                }
                
                // Get current view
                const currentView = AppRegistry.get('views', currentViewId);
                
                // Deactivate current view if it exists
                if (currentView) {
                    try {
                        if (!currentView.deactivate()) {
                            console.error(`Failed to deactivate view: ${currentViewId}`);
                            return false;
                        }
                    } catch (error) {
                        console.error(`Error deactivating view ${currentViewId}:`, error);
                        return false;
                    }
                }
                
                // Activate new view
                try {
                    if (!newView.activate()) {
                        console.error(`Failed to activate view: ${viewId}`);
                        
                        // Try to reactivate previous view
                        if (currentView) {
                            currentView.activate();
                        }
                        
                        return false;
                    }
                } catch (error) {
                    console.error(`Error activating view ${viewId}:`, error);
                    
                    // Try to reactivate previous view
                    if (currentView) {
                        currentView.activate();
                    }
                    
                    return false;
                }
                
                // Update application state
                AppState.setActiveView(viewId);
                
                return true;
            },
            
            /**
             * Get list of available views
             * 
             * @returns {Array} - Array of view objects
             */
            getAvailableViews: function() {
                const views = AppRegistry.getAll('views');
                return Object.values(views);
            }
        };
        
        
        // ===================================================
        // PLUGIN MANAGER - Handle plugins
        // ===================================================
        
        const PluginManager = {
            /**
             * Mapping of plugin IDs to script elements
             */
            pluginScripts: {},
            
            /**
             * Initialize the plugin manager system
             */
            init: function() {
                // Register with the application registry
                AppRegistry.register('core', 'pluginManager', this);
                
                return this;
            },
            
            /**
             * Open the plugin manager modal
             */
            openManager: function() {
                const modal = DomUI.elements['plugin-modal'];
                if (modal) {
                    modal.classList.add('active');
                    
                    // Update plugin list
                    DomUI.updatePluginList();
                }
            },
            
            /**
             * Close the plugin manager modal
             */
            closeManager: function() {
                const modal = DomUI.elements['plugin-modal'];
                if (modal) {
                    modal.classList.remove('active');
                }
            },
            
            /**
             * Upload and install a plugin
             * 
             * @param {File} file - Plugin file
             */
            uploadPlugin: function(file) {
                if (!file || !file.name.toLowerCase().endsWith('.js')) {
                    DomUI.showNotification('Invalid plugin file. Please select a JavaScript file.', 'error');
                    return;
                }
                
                DomUI.showLoading(true);
                
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const pluginCode = e.target.result;
                        this.installPlugin(file.name, pluginCode);
                        DomUI.showLoading(false);
                    } catch (error) {
                        console.error('Error loading plugin:', error);
                        DomUI.showNotification('Error loading plugin: ' + error.message, 'error');
                        DomUI.showLoading(false);
                    }
                };
                
                reader.onerror = () => {
                    DomUI.showNotification('Error reading plugin file', 'error');
                    DomUI.showLoading(false);
                };
                
                reader.readAsText(file);
            },
            
            /**
             * Install a plugin from code
             * 
             * @param {string} fileName - Plugin file name
             * @param {string} pluginCode - Plugin code
             * @returns {boolean} - Success status
             */
            installPlugin: function(fileName, pluginCode) {
                try {
                    // Create a sandbox for plugin execution
                    const pluginSandbox = {
                        registerPlugin: this.registerPlugin.bind(this),
                        AppRegistry: AppRegistry,
                        EventBus: EventBus,
                        Utils: Utils,
                        AppState: AppState // Provide direct access to state
                    };
                    
                    // Create a function from the plugin code
                    const pluginFunction = new Function('sandbox', `
                        with (sandbox) {
                            ${pluginCode}
                        }
                        return sandbox;
                    `);
                    
                    // Execute the plugin code
                    pluginFunction(pluginSandbox);
                    
                    // Update plugin list
                    DomUI.updatePluginList();
                    
                    // Update view selector if needed
                    DomUI.updateViewSelector();
                    
                    // Show success message
                    DomUI.showNotification(`Plugin "${fileName}" installed successfully`, 'success');
                    return true;
                } catch (error) {
                    console.error('Error installing plugin:', error);
                    DomUI.showNotification(`Error installing plugin: ${error.message}`, 'error');
                    return false;
                }
            },
            
            /**
             * Register a plugin
             * 
             * @param {Object} plugin - Plugin definition
             * @returns {boolean} - Success status
             */
            registerPlugin: function(plugin) {
                // Validate plugin
                if (!plugin || !plugin.id || !plugin.name || !plugin.init) {
                    console.error('Invalid plugin definition:', plugin);
                    return false;
                }
                
                // Check for existing plugin
                if (AppRegistry.exists('plugins', plugin.id)) {
                    console.error(`Plugin with ID "${plugin.id}" already exists`);
                    return false;
                }
                
                // Initialize the plugin
                try {
                    plugin.init();
                } catch (error) {
                    console.error(`Error initializing plugin "${plugin.id}":`, error);
                    return false;
                }
                
                // Register the plugin
                if (!AppRegistry.register('plugins', plugin.id, plugin)) {
                    return false;
                }
                
                // Notify listeners
                EventBus.publish('plugins:registered', {
                    plugin: plugin
                });
                
                return true;
            },
            
            /**
             * Unregister a plugin
             * 
             * @param {string} pluginId - Plugin ID
             * @returns {boolean} - Success status
             */
            unregisterPlugin: function(pluginId) {
                const plugin = AppRegistry.get('plugins', pluginId);
                
                if (!plugin) {
                    console.error(`Plugin not found: ${pluginId}`);
                    return false;
                }
                
                // Call plugin cleanup if available
                if (typeof plugin.cleanup === 'function') {
                    try {
                        plugin.cleanup();
                    } catch (error) {
                        console.error(`Error during plugin cleanup for "${pluginId}":`, error);
                        // Continue with unregistration despite cleanup error
                    }
                }
                
                // Unregister plugin
                if (!AppRegistry.unregister('plugins', pluginId)) {
                    return false;
                }
                
                // Remove script element if it exists
                if (this.pluginScripts[pluginId]) {
                    document.head.removeChild(this.pluginScripts[pluginId]);
                    delete this.pluginScripts[pluginId];
                }
                
                // Notify listeners
                EventBus.publish('plugins:unregistered', {
                    pluginId: pluginId
                });
                
                return true;
            },
            
            /**
             * Enable a plugin
             * 
             * @param {string} pluginId - Plugin ID
             * @returns {boolean} - Success status
             */
            enablePlugin: function(pluginId) {
                const plugin = AppRegistry.get('plugins', pluginId);
                
                if (!plugin) {
                    console.error(`Plugin not found: ${pluginId}`);
                    return false;
                }
                
                // Call enable method if available
                if (typeof plugin.enable === 'function') {
                    try {
                        plugin.enable();
                    } catch (error) {
                        console.error(`Error enabling plugin "${pluginId}":`, error);
                        return false;
                    }
                }
                
                // Update enabled state
                plugin.enabled = true;
                
                // Notify listeners
                EventBus.publish('plugins:enabled', {
                    pluginId: pluginId,
                    plugin: plugin
                });
                
                // Update UI
                DomUI.updatePluginList();
                
                return true;
            },
            
            /**
             * Disable a plugin
             * 
             * @param {string} pluginId - Plugin ID
             * @returns {boolean} - Success status
             */
            disablePlugin: function(pluginId) {
                const plugin = AppRegistry.get('plugins', pluginId);
                
                if (!plugin) {
                    console.error(`Plugin not found: ${pluginId}`);
                    return false;
                }
                
                // Call disable method if available
                if (typeof plugin.disable === 'function') {
                    try {
                        plugin.disable();
                    } catch (error) {
                        console.error(`Error disabling plugin "${pluginId}":`, error);
                        return false;
                    }
                }
                
                // Update enabled state
                plugin.enabled = false;
                
                // Notify listeners
                EventBus.publish('plugins:disabled', {
                    pluginId: pluginId,
                    plugin: plugin
                });
                
                // Update UI
                DomUI.updatePluginList();
                
                return true;
            }
        };
        
        
        // ===================================================
        // APPLICATION - Core functionality
        // ===================================================
        
        const App = {
            /**
             * Initialize the application
             */
            init: function() {
                // Initialize core components
                AppState.init();
                Utils.init();
                CsvProcessor.init();
                FilterSystem.init();
                FileHandler.init();
                ViewController.init();
                PluginManager.init();
                ThemeManager.init();
                
                // Initialize UI last, as it depends on other components
                DomUI.init();
                
                // Register the application with the registry
                AppRegistry.register('core', 'app', this);
                
                return this;
            },
            
            /**
             * Run a filter on the current active file's data
             */
            runFilter: function() {
                // Get search parameters
                const fieldName = DomUI.elements['field'].value;
                const searchTerm = DomUI.elements['search'].value;
                
                // Get currently active file
                const activeFile = AppState.getActiveFile();
                if (!activeFile) return;
                
                // If either field is empty, show all data
                if (!fieldName || !searchTerm) {
                    AppState.setFilteredData(activeFile.rawData);
                    return;
                }
                
                // Create a filter from the search inputs
                const filter = FilterSystem.createFromSearch(fieldName, searchTerm);
                
                // Apply the filter to the raw data
                const filteredData = filter ? 
                    FilterSystem.applyFilter(activeFile.rawData, filter) : 
                    activeFile.rawData;
                
                // Update the application state with filtered data
                AppState.setFilteredData(filteredData, fieldName, searchTerm);
            },
            
            /**
             * Clear the current search
             */
            clearSearch: function() {
                // Reset form fields
                if (DomUI.elements['field']) DomUI.elements['field'].value = '';
                if (DomUI.elements['search']) DomUI.elements['search'].value = '';
                
                // Get currently active file
                const activeFile = AppState.getActiveFile();
                if (!activeFile) return;
                
                // Reset to full dataset
                AppState.setFilteredData(activeFile.rawData);
            }
        };
        
        
        // Initialize the application when the DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            App.init();
            
            // Log initialization message
            console.log('DataTrellis initialized');
        });
    </script>
</body>
</html>